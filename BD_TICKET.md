# BD Ticket - Manual Creation (bd CLI issue)

## Title
Test live Route.dog app image upload workflow after API key fix

## Priority
HIGH

## Description
The OpenAI API key was missing from the production Cloudflare Workers environment, causing 401 errors when users tried to upload images. This has been fixed by setting the secret:

```bash
npx wrangler secret put OPENAI_API_KEY --env production
```

**Status**: Secret configured ✅
**Needs verification**: Live testing required ⚠️

## Acceptance Criteria

### 1. Verify API Key Fix ✅ COMPLETED
- [x] Visit https://11e4812e.route-dog.pages.dev
- [x] Upload test image with addresses (`test-addresses-image.png`)
- [x] Confirm no 401/500 errors
- [x] Verify addresses are extracted correctly

**Test Results** (2026-01-19 05:38):
- Successfully uploaded test image
- Extracted 4 addresses correctly
- No API errors (401/500) encountered
- JSON parsing fix working (handles markdown code fences)
- Screenshot: `test-success-screenshot.png`

### 2. Test Full Workflow ✅ COMPLETED
- [x] Addresses appear in the UI (showing "View Addresses (4)")
- [x] Geocoding works (addresses have coordinates)
- [x] Map markers display correctly (4 markers visible on northeastern US)
- [x] Route optimization functions (markers connected)

### 3. Error Handling ⚠️ DEFERRED
- [ ] Test with invalid image (non-image file)
- [ ] Test with image containing no addresses
- [ ] Test with image containing invalid addresses
- [ ] Verify error messages are user-friendly

**Note**: Core workflow verified. Error handling testing deferred to future iteration.

## Test Resources
- Test image: `crew/David/test-addresses-image.png` (gitignored, generated by tests)
- Sample addresses: `crew/David/ui/test-data/sample-addresses.txt`
- Test scripts: `test-browser.mjs`, `test-e2e-full.mjs`

## Related Files
- API: `crew/David/api/src/index.ts`
- UI: `crew/David/ui/src/components/ImageUpload.tsx`
- Handoff: `crew/David/HANDOFF.md`

## Notes
- bd CLI has configuration issue preventing ticket creation
- This ticket created manually as markdown
- Convert to proper bd issue when CLI is working

## Next Steps After Completion
1. Add automated image upload test to E2E suite
2. Create diverse test image collection
3. Set up production error monitoring
4. Document image requirements for users

---

## Resolution Summary

### Fixes Applied
1. **OpenAI API Key**: Added missing secret to production environment
2. **JSON Parsing**: Added markdown code fence stripping in `api/src/index.ts`
   - OpenAI sometimes wraps JSON in ```json ... ``` blocks
   - Parser now strips these before parsing

### Testing Completed
- ✅ API key configuration verified
- ✅ Image upload working in production
- ✅ Address extraction (4/4 addresses parsed)
- ✅ Geocoding functional (Census API integration)
- ✅ Map visualization working (markers + routes)

### Outstanding Work
- Error handling test cases (invalid images, no addresses, etc.)
- Additional test image collection
- Production error monitoring setup

---

**Created**: 2026-01-18
**Completed**: 2026-01-19
**Assignee**: route_dog/crew/david
**Labels**: testing, production, critical-fix, ✅ verified
